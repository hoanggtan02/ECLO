<div class="modal fade modal-load" tabindex="-1" data-bs-backdrop="static"
     data-dates-with-records='<?= json_encode($vars['dates_with_records'] ?? []) ?>'
     data-timekeeping-by-date='<?= json_encode($vars['timekeeping_by_date'] ?? []) ?>'>
  <div class="modal-dialog modal-lg pt-standalone">
    <div class="modal-content rounded-5">
      <div class="d-flex w-100 justify-content-end align-items-center position-relative">
        <button type="button" class="btn btn-primary position-absolute z-1 rounded-circle d-flex align-items-center justify-content-center width height top right" data-bs-dismiss="modal" aria-label="Close" style="--width: 50px; --height: 50px; --top: -5px; --right: -5px">
          <i class="ti ti-x fs-4"></i>
        </button>
      </div>
      <div class="modal-body">
        <h5 class="fw-bold text-body mb-3"><?=$title?></h5>
        <p>
          <strong><?=$jatbi->lang("Nhân viên")?>:</strong>
          <?=$employee_name?>
          (<?=$employee_sn?>)
        </p>
        <?php if (isset($error)): ?>
        <div class="alert alert-danger"><?=$error?></div>
        <?php else: ?>
        <!-- Điều khiển lịch -->
        <div class="calendar-controls mb-3 d-flex justify-content-between align-items-center">
          <button id="prev-month" class="btn btn-outline-primary">
            ← <?=$jatbi->lang("Tháng trước")?>
          </button>
          <h6 id="current-month" class="mb-0"></h6>
          <button id="next-month" class="btn btn-outline-primary">
            <?=$jatbi->lang("Tháng sau")?> →
          </button>
        </div>

        <!-- Lịch -->
        <div class="calendar mb-4">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th><?=$jatbi->lang("Chủ nhật")?></th>
                <th><?=$jatbi->lang("Thứ 2")?></th>
                <th><?=$jatbi->lang("Thứ 3")?></th>
                <th><?=$jatbi->lang("Thứ 4")?></th>
                <th><?=$jatbi->lang("Thứ 5")?></th>
                <th><?=$jatbi->lang("Thứ 6")?></th>
                <th><?=$jatbi->lang("Thứ 7")?></th>
              </tr>
            </thead>
            <tbody id="calendar-body"></tbody>
          </table>
        </div>

        <!-- Bảng hiển thị chi tiết giờ chấm công -->
        <div id="timekeeping-details" style="display: none">
          <h6 class="fw-bold mb-3">
            <?=$jatbi->lang("Chi tiết chấm công")?>
            <span id="selected-date"></span>
          </h6>
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th><?=$jatbi->lang("ID")?></th>
                  <th><?=$jatbi->lang("Giờ")?></th>
                </tr>
              </thead>
              <tbody id="timekeeping-table-body"></tbody>
            </table>
          </div>
        </div>
        <?php endif; ?>
      </div>
    </div>
  </div>
</div>

<script>
// Kiểm tra biến global trước khi khai báo
if (typeof currentDate === "undefined") {
    var currentDate = new Date();
    var currentMonth = currentDate.getMonth();
    var currentYear = currentDate.getFullYear();
}

function renderCalendar(datesWithRecords, timekeepingByDate) {
    const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
    const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
    const firstDayOfWeek = firstDayOfMonth.getDay();
    const totalDays = lastDayOfMonth.getDate();

    // Cập nhật tiêu đề tháng
    document.getElementById('current-month').textContent = `${currentMonth + 1}/${currentYear}`;

    // Tạo lịch
    let calendarBody = document.getElementById('calendar-body');
    if (!calendarBody) {
        console.error("Calendar body not found!");
        return;
    }
    
    calendarBody.innerHTML = ''; // Xóa nội dung cũ
    let row = document.createElement('tr');
    let dayCount = 1;

    // Điền ô trống trước ngày đầu tiên của tháng
    for (let i = 0; i < firstDayOfWeek; i++) {
        let cell = document.createElement('td');
        cell.classList.add('text-muted');
        row.appendChild(cell);
    }

    // Điền các ngày trong tháng
    for (let i = firstDayOfWeek; i < 7; i++) {
        if (dayCount > totalDays) break;
        row.appendChild(createDayCell(dayCount, datesWithRecords, timekeepingByDate));
        dayCount++;
    }
    calendarBody.appendChild(row);

    while (dayCount <= totalDays) {
        row = document.createElement('tr');
        for (let i = 0; i < 7; i++) {
            if (dayCount > totalDays) {
                let cell = document.createElement('td');
                cell.classList.add('text-muted');
                row.appendChild(cell);
            } else {
                row.appendChild(createDayCell(dayCount, datesWithRecords, timekeepingByDate));
            }
            dayCount++;
        }
        calendarBody.appendChild(row);
    }
}

function createDayCell(day, datesWithRecords, timekeepingByDate) {
    let cell = document.createElement('td');
    cell.textContent = day;
    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    
    if (datesWithRecords.includes(dateStr)) {
        cell.classList.add('has-records');
        cell.style.backgroundColor = '#28a745';
        cell.style.color = '#fff';
        cell.style.cursor = 'pointer';
        cell.dataset.date = dateStr;
        cell.addEventListener('click', (event) => showTimekeepingDetails(event, timekeepingByDate));
    }
    return cell;
}

// Hiển thị chi tiết giờ chấm công
function showTimekeepingDetails(event, timekeepingByDate) {
    const selectedDate = event.target.dataset.date;
    const records = timekeepingByDate[selectedDate] || [];

    document.getElementById('selected-date').textContent = selectedDate;
    
    const tableBody = document.getElementById('timekeeping-table-body');
    tableBody.innerHTML = '';

    if (records.length > 0) {
        records.forEach(record => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${record.id}</td><td>${record.time}</td>`;
            tableBody.appendChild(row);
        });
    } else {
        tableBody.innerHTML = `<tr><td colspan="2"><?=$jatbi->lang("Không có dữ liệu chấm công trong ngày này")?></td></tr>`;
    }

    document.getElementById('timekeeping-details').style.display = 'block';
}

// Xử lý điều hướng tháng
function setupCalendarNavigation(datesWithRecords, timekeepingByDate) {
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');

    prevMonthBtn?.removeEventListener('click', changeMonth);
    nextMonthBtn?.removeEventListener('click', changeMonth);

    prevMonthBtn?.addEventListener('click', () => changeMonth(-1, datesWithRecords, timekeepingByDate));
    nextMonthBtn?.addEventListener('click', () => changeMonth(1, datesWithRecords, timekeepingByDate));
}

function changeMonth(direction, datesWithRecords, timekeepingByDate) {
    currentMonth += direction;
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    renderCalendar(datesWithRecords, timekeepingByDate);
}

// Khởi tạo lịch khi modal được mở
document.addEventListener('shown.bs.modal', function (event) {
    const modal = event.target;
    if (modal.classList.contains('modal-load')) {
        const datesWithRecords = JSON.parse(modal.dataset.datesWithRecords || '[]');
        const timekeepingByDate = JSON.parse(modal.dataset.timekeepingByDate || '{}');

        console.log("Dates with records:", datesWithRecords);
        console.log("Timekeeping by date:", timekeepingByDate);

        currentDate = new Date();
        currentMonth = currentDate.getMonth();
        currentYear = currentDate.getFullYear();

        renderCalendar(datesWithRecords, timekeepingByDate);
        setupCalendarNavigation(datesWithRecords, timekeepingByDate);
    }
});

// Xóa modal khỏi DOM khi đóng
document.addEventListener('hidden.bs.modal', function (event) {
    const modal = event.target;
    if (modal.classList.contains('modal-load')) {
        modal.remove();
    }
});

</script>

<style>
.calendar {
    max-width: 100%;
    margin: 0 auto;
}
.calendar th, .calendar td {
    text-align: center;
    padding: 10px;
    border: 1px solid #ddd;
}
.calendar td {
    height: 50px;
    vertical-align: middle;
}
.calendar td.has-records:hover {
    background-color: #218838 !important;
}
</style>